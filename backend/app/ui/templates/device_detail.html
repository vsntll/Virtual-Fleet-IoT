{% extends "base.html" %}

{% block title %}Device {{ device.id }}{% endblock %}

{% block content %}
    {% if device %}
    <h1 class="text-2xl font-bold mb-4">Device Details: {{ device.id }}</h1>
    <p><strong>Status:</strong> {{ device.status }}</p>
    <p><strong>Current Version:</strong> {{ device.current_version }}</p>
    <p><strong>Desired Version:</strong> {{ device.desired_version }}</p>
    <p><strong>Last Seen:</strong> {{ device.last_seen }}</p>
    <p><strong>Environment:</strong> {{ device.environment }}</p>

    <h2>Device State (Shadow)</h2>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Reported</th>
                <th>Desired</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Sample Interval (s)</td>
                <td>{{ device.reported_sample_interval_secs }}</td>
                <td class="{% if device.reported_sample_interval_secs != device.desired_sample_interval_secs %}unconverged{% endif %}">{{ device.desired_sample_interval_secs }}</td>
            </tr>
            <tr>
                <td>Upload Interval (s)</td>
                <td>{{ device.reported_upload_interval_secs }}</td>
                <td class="{% if device.reported_upload_interval_secs != device.desired_upload_interval_secs %}unconverged{% endif %}">{{ device.desired_upload_interval_secs }}</td>
            </tr>
            <tr>
                <td>Heartbeat Interval (s)</td>
                <td>{{ device.reported_heartbeat_interval_secs }}</td>
                <td class="{% if device.reported_heartbeat_interval_secs != device.desired_heartbeat_interval_secs %}unconverged{% endif %}">{{ device.desired_heartbeat_interval_secs }}</td>
            </tr>
        </tbody>
    </table>

    <h2>Update Desired State</h2>
    <form id="update-state-form">
        <div class="control-group">
            <label for="desired_sample_interval_secs">Desired Sample Interval (s):</label>
            <input type="number" id="desired_sample_interval_secs" name="desired_sample_interval_secs" value="{{ device.desired_sample_interval_secs }}">
        </div>
        <div class="control-group">
            <label for="desired_upload_interval_secs">Desired Upload Interval (s):</label>
            <input type="number" id="desired_upload_interval_secs" name="desired_upload_interval_secs" value="{{ device.desired_upload_interval_secs }}">
        </div>
        <div class="control-group">
            <label for="desired_heartbeat_interval_secs">Desired Heartbeat Interval (s):</label>
            <input type="number" id="desired_heartbeat_interval_secs" name="desired_heartbeat_interval_secs" value="{{ device.desired_heartbeat_interval_secs }}">
        </div>
        <button type="submit">Update Desired State</button>
    </form>
    
    <h2>Change Environment</h2>
    <form id="update-environment-form">
        <div class="control-group">
            <label for="environment">Environment:</label>
            <select id="environment" name="environment">
                <option value="blue" {% if device.environment == 'blue' %}selected{% endif %}>Blue</option>
                <option value="green" {% if device.environment == 'green' %}selected{% endif %}>Green</option>
            </select>
        </div>
        <button type="submit">Change Environment</button>
    </form>

    <h2>Config Flags</h2>
    <form id="update-config-flags-form">
        <div class="control-group">
            <label for="config_flags_json">Edit JSON Config Flags:</label>
            <textarea id="config_flags_json" name="config_flags_json" rows="10" cols="50" class="w-full p-2 border rounded-md font-mono text-sm">{{ config_flags | tojson(indent=2) }}</textarea>
        </div>
        <button type="submit" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
            Update Config Flags
        </button>
    </form>

    <h2>Recent Measurements</h2>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Temperature</th>
                <th>Humidity</th>
                <th>Battery</th>
            </tr>
        </thead>
        <tbody>
            {% for m in measurements %}
            <tr>
                <td>{{ m.timestamp }}</td>
                <td>{{ m.temp }}</td>
                <td>{{ m.humidity }}</td>
                <td>{{ m.battery }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <h1>Device not found</h1>
    {% endif %}
    <br>
    <a href="/devices/{{ device.id }}/analysis" class="button">View Analysis</a>
    <a href="/">Back to Fleet</a>

{% endblock %}

{% block scripts %}
    <script>
        document.getElementById('update-state-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            for (const key in data) {
                data[key] = parseInt(data[key], 10);
            }

            fetch('/api/devices/{{ device.id }}/state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('Desired state updated successfully. The device will update on its next heartbeat.');
                // Optionally, refresh the page to see the new desired state
                window.location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to update desired state.');
            });
        });

        document.getElementById('update-environment-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetch('/api/devices/{{ device.id }}/environment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('Environment updated successfully.');
                window.location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to update environment.');
            });
        });

        document.getElementById('update-config-flags-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const configFlagsJson = document.getElementById('config_flags_json').value;
            
            let payload;
            try {
                payload = JSON.parse(configFlagsJson);
            } catch (error) {
                alert('Invalid JSON in Config Flags. Please correct it.');
                console.error('JSON parsing error:', error);
                return;
            }

            fetch('/api/devices/{{ device.id }}/config_flags', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ config_flags: payload }),
            })
            .then(response => {
                if (response.ok) {
                    alert('Config Flags updated successfully!');
                    window.location.reload();
                } else {
                    alert('Failed to update Config Flags. See console for details.');
                    console.error('Error response:', response);
                }
            })
            .catch((error) => {
                alert('An error occurred during update. See console for details.');
                console.error('Fetch error:', error);
            });
        });
    </script>
{% endblock %}
