{% extends "base.html" %}

{% block title %}Fleet Map{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"
          crossorigin=""/>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Fleet Map View</h1>

<div id="map"></div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"
            crossorigin=""></script>
    <script>
        var map = L.map('map').setView([0, 0], 2); // Centered at [0,0] with zoom 2

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var devices_data = {{ devices_data | tojson | safe }};

        devices_data.forEach(function(device) {
            if (device.latitude && device.longitude) {
                var markerColor = 'blue'; // Default
                if (device.status === 'online') {
                    markerColor = 'green';
                } else if (device.status === 'offline') {
                    markerColor = 'red';
                }
                // More complex color logic could be added based on firmware version or health

                var markerHtml = `<div style="background-color:${markerColor}; width: 1.5rem; height: 1.5rem; display: block; left: -0.75rem; top: -0.75rem; position: relative; border-radius: 1.5rem 1.5rem 0; transform: rotate(45deg); border: 1px solid #FFFFFF"></div>`
                var customIcon = L.divIcon({
                    className: 'my-custom-pin',
                    iconAnchor: [0, 24],
                    popupAnchor: [0, -36],
                    html: markerHtml
                });

                L.marker([device.latitude, device.longitude], {icon: customIcon})
                    .addTo(map)
                    .bindPopup(`<b>Device ID: ${device.id}</b><br>Status: ${device.status}<br>Version: ${device.current_version}<br>Environment: ${device.environment}`);
            }
        });
        
        // Adjust map to show all markers if any exist
        if (devices_data.length > 0) {
            var latLngs = devices_data.filter(d => d.latitude && d.longitude).map(d => [d.latitude, d.longitude]);
            if (latLngs.length > 0) {
                var bounds = L.latLngBounds(latLngs);
                map.fitBounds(bounds);
            }
        }
    </script>
{% endblock %}
